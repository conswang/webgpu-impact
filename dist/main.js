(()=>{"use strict";class e{constructor(e){this.texture=void 0,this.sampler=void 0,this.bitmap=void 0,this.filepath=void 0,this.filepath=e}setFilepath(e){this.filepath=e}create(e){return t=this,r=void 0,s=function*(){const t=document.createElement("img");t.src=new URL(this.filepath,"file:///C:/Users/eyada/Desktop/webgpu-impact/src/types/texture.ts").toString(),yield t.decode();const r=yield fetch(this.filepath);if(!r.ok)return console.error("Network error",r.status);const i=yield r.blob();this.bitmap=yield createImageBitmap(i),console.log(this.bitmap),this.texture=e.createTexture({size:[this.bitmap.width,this.bitmap.height],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),e.queue.copyExternalImageToTexture({source:this.bitmap},{texture:this.texture},[this.bitmap.width,this.bitmap.height])},new((i=void 0)||(i=Promise))((function(e,o){function n(e){try{h(s.next(e))}catch(e){o(e)}}function a(e){try{h(s.throw(e))}catch(e){o(e)}}function h(t){var r;t.done?e(t.value):(r=t.value,r instanceof i?r:new i((function(e){e(r)}))).then(n,a)}h((s=s.apply(t,r||[])).next())}));var t,r,i,s}}class t{constructor(e){this.vertCount=0,this.idxCount=0,this.positions=new Array,this.normals=new Array,this.uvs=new Array,this.faces=new Array,this.texture=void 0,this.createCube(),this.populateVBO();const t=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,r={size:this.vertDataVBO.byteLength,usage:t,mappedAtCreation:!0};this.buffer=e.createBuffer(r),new Float32Array(this.buffer.getMappedRange()).set(this.vertDataVBO),this.buffer.unmap(),this.bufferLayout={arrayStride:32,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12},{shaderLocation:2,format:"float32x2",offset:24}]}}createTexture(t,r){return i=this,s=void 0,n=function*(){this.texture=new e(r),yield this.texture.create(t)},new((o=void 0)||(o=Promise))((function(e,t){function r(e){try{h(n.next(e))}catch(e){t(e)}}function a(e){try{h(n.throw(e))}catch(e){t(e)}}function h(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(r,a)}h((n=n.apply(i,s||[])).next())}));var i,s,o,n}addVertex(e){console.log("adding vertex"),console.log(e.pos),console.log(e.nor),console.log(e.uv),this.positions.push(e.pos),this.normals.push(e.nor),this.uvs.push(e.uv),this.vertCount++}addFace(e){let t=new Array;for(let r=0;r<e.length;r++)t.push(this.vertCount),this.addVertex(e[r]);this.faces.push(new r(t))}addFaceIndices(e){this.faces.push(new r(e))}populateVBO(){var e=new Array;for(let t=0;t<this.faces.length;t++){const r=this.faces[t];for(let t=0;t<r.vertCount-2;t++){const i=this.positions[r.verts[0]],s=this.positions[r.verts[t+1]],o=this.positions[r.verts[t+2]],n=this.normals[r.verts[0]],a=this.normals[r.verts[t+1]],h=this.normals[r.verts[t+2]],u=this.uvs[r.verts[0]],c=this.uvs[r.verts[t+1]],p=this.uvs[r.verts[t+2]];e.push(i[0]),e.push(i[1]),e.push(i[2]),e.push(n[0]),e.push(n[1]),e.push(n[2]),e.push(u[0]),e.push(u[1]),e.push(s[0]),e.push(s[1]),e.push(s[2]),e.push(a[0]),e.push(a[1]),e.push(a[2]),e.push(c[0]),e.push(c[1]),e.push(o[0]),e.push(o[1]),e.push(o[2]),e.push(h[0]),e.push(h[1]),e.push(h[2]),e.push(p[0]),e.push(p[1]),this.idxCount+=3,console.log("Adding Triangle"),console.log([0,t+1,t+2]),console.log([r.verts[0],r.verts[t+1],r.verts[t+2]])}}this.vertDataVBO=new Float32Array(e),console.log(this.vertCount),console.log(this.idxCount)}createCube(){let e=new Array;e.push({pos:[-1,-1,-1],nor:[0,0,-1],uv:[0,0]}),e.push({pos:[1,-1,-1],nor:[0,0,-1],uv:[0,1]}),e.push({pos:[1,1,-1],nor:[0,0,-1],uv:[1,1]}),e.push({pos:[-1,1,-1],nor:[0,0,-1],uv:[1,0]});let t=new Array;t.push({pos:[-1,-1,1],nor:[0,0,1],uv:[0,0]}),t.push({pos:[1,-1,1],nor:[0,0,1],uv:[0,1]}),t.push({pos:[1,1,1],nor:[0,0,1],uv:[1,1]}),t.push({pos:[-1,1,1],nor:[0,0,1],uv:[1,0]});let r=new Array;r.push({pos:[-1,-1,-1],nor:[0,-1,0],uv:[0,0]}),r.push({pos:[1,-1,-1],nor:[0,-1,0],uv:[0,1]}),r.push({pos:[1,-1,1],nor:[0,-1,0],uv:[1,1]}),r.push({pos:[-1,-1,1],nor:[0,-1,0],uv:[1,0]});let i=new Array;i.push({pos:[-1,1,-1],nor:[0,1,0],uv:[0,0]}),i.push({pos:[1,1,-1],nor:[0,1,0],uv:[0,1]}),i.push({pos:[1,1,1],nor:[0,1,0],uv:[1,1]}),i.push({pos:[-1,1,1],nor:[0,1,0],uv:[1,0]});let s=new Array;s.push({pos:[-1,-1,-1],nor:[-1,0,0],uv:[0,0]}),s.push({pos:[-1,1,-1],nor:[-1,0,0],uv:[0,1]}),s.push({pos:[-1,1,1],nor:[-1,0,0],uv:[1,1]}),s.push({pos:[-1,-1,1],nor:[-1,0,0],uv:[1,0]});let o=new Array;o.push({pos:[1,-1,-1],nor:[1,0,0],uv:[0,0]}),o.push({pos:[1,1,-1],nor:[1,0,0],uv:[0,1]}),o.push({pos:[1,1,1],nor:[1,0,0],uv:[1,1]}),o.push({pos:[1,-1,1],nor:[1,0,0],uv:[1,0]}),this.addFace(e),this.addFace(t),this.addFace(r),this.addFace(i),this.addFace(s),this.addFace(o)}}class r{constructor(e){this.vertCount=0,this.verts=new Array;for(let t=0;t<e.length;t++)this.verts.push(e[t]);this.vertCount=e.length}addVertex(e){this.verts.push(e),this.vertCount++}}var i,s=1e-6,o="undefined"!=typeof Float32Array?Float32Array:Array;function n(){var e=new o(3);return o!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function a(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function h(e,t){var r=t[0],i=t[1],s=t[2],o=r*r+i*i+s*s;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function u(){var e=new o(16);return o!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),n(),i=new o(2),o!=Float32Array&&(i[0]=0,i[1]=0);class c{constructor(e,t,r,i,s,u,c,p){var l,f,v;this.eye=n(),this.ref=n(),this.up=n(),this.right=n(),this.look=n(),this.fovy=e,this.aspect=(l=t,f=r,(v=new o(2))[0]=l,v[1]=f,v),this.nearClip=i,this.farClip=s,a(this.eye,u),a(this.ref,c),a(this.up,p),h(this.up,this.up),function(e,t,r){e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2]}(this.look,c,u),h(this.look,this.look),function(e,t,r){var i=t[0],s=t[1],o=t[2],n=r[0],a=r[1],h=r[2];e[0]=s*h-o*a,e[1]=o*n-i*h,e[2]=i*a-s*n}(this.right,this.look,p),h(this.right,this.right)}project(){var e=u();return function(e,t,r,i,s){var o,n=1/Math.tan(t/2);e[0]=n/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(o=1/(i-s),e[10]=(s+i)*o,e[14]=2*s*i*o):(e[10]=-1,e[14]=-2*i)}(e,this.fovy,this.aspect[0]/this.aspect[1],this.nearClip,this.farClip),e}view(){var e=u();return function(e,t,r,i){var o,n,a,h,u,c,p,l,f,v,d=t[0],m=t[1],g=t[2],y=i[0],x=i[1],w=i[2],b=r[0],T=r[1],A=r[2];Math.abs(d-b)<s&&Math.abs(m-T)<s&&Math.abs(g-A)<s?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(p=d-b,l=m-T,f=g-A,o=x*(f*=v=1/Math.hypot(p,l,f))-w*(l*=v),n=w*(p*=v)-y*f,a=y*l-x*p,(v=Math.hypot(o,n,a))?(o*=v=1/v,n*=v,a*=v):(o=0,n=0,a=0),h=l*a-f*n,u=f*o-p*a,c=p*n-l*o,(v=Math.hypot(h,u,c))?(h*=v=1/v,u*=v,c*=v):(h=0,u=0,c=0),e[0]=o,e[1]=h,e[2]=p,e[3]=0,e[4]=n,e[5]=u,e[6]=l,e[7]=0,e[8]=a,e[9]=c,e[10]=f,e[11]=0,e[12]=-(o*d+n*m+a*g),e[13]=-(h*d+u*m+c*g),e[14]=-(p*d+l*m+f*g),e[15]=1)}(e,this.eye,this.ref,this.up),e}model(e){var t=u();return function(e,t,r,i){var o,n,a,h,u,c,p,l,f,v,d,m,g,y,x,w,b,T,A,P,U,B,C,F,E=i[0],M=i[1],S=i[2],G=Math.hypot(E,M,S);G<s||(E*=G=1/G,M*=G,S*=G,o=Math.sin(r),a=1-(n=Math.cos(r)),h=t[0],u=t[1],c=t[2],p=t[3],l=t[4],f=t[5],v=t[6],d=t[7],m=t[8],g=t[9],y=t[10],x=t[11],w=E*E*a+n,b=M*E*a+S*o,T=S*E*a-M*o,A=E*M*a-S*o,P=M*M*a+n,U=S*M*a+E*o,B=E*S*a+M*o,C=M*S*a-E*o,F=S*S*a+n,e[0]=h*w+l*b+m*T,e[1]=u*w+f*b+g*T,e[2]=c*w+v*b+y*T,e[3]=p*w+d*b+x*T,e[4]=h*A+l*P+m*U,e[5]=u*A+f*P+g*U,e[6]=c*A+v*P+y*U,e[7]=p*A+d*P+x*U,e[8]=h*B+l*C+m*F,e[9]=u*B+f*C+g*F,e[10]=c*B+v*C+y*F,e[11]=p*B+d*C+x*F,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]))}(t,t,e,[0,0,1]),t}}class p{constructor(e,t){this.pos=n(),this.col=n(),this.pos=e,this.col=t}}var l=function(e,t,r,i){return new(r||(r=Promise))((function(s,o){function n(e){try{h(i.next(e))}catch(e){o(e)}}function a(e){try{h(i.throw(e))}catch(e){o(e)}}function h(e){var t;e.done?s(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,a)}h((i=i.apply(e,t||[])).next())}))};const f=document.getElementById("gfx-main"),v=new class{constructor(e){this.size=new Array(2),this.time=0,this.timeStep=.01,this.samples=4,this.render=()=>{var e,t,r,i,s,o,n,a,h,c,p,l,f,v,d,m,g,y,x,w,b,T,A,P,U,B,C,F,E,M,S,G=this.camera.model(this.time),z=u();e=z,r=(t=G)[0],i=t[1],s=t[2],o=t[3],n=t[4],a=t[5],h=t[6],c=t[7],p=t[8],l=t[9],f=t[10],v=t[11],d=t[12],m=t[13],g=t[14],(S=(x=r*a-i*n)*(M=f*(y=t[15])-v*g)-(w=r*h-s*n)*(E=l*y-v*m)+(b=r*c-o*n)*(F=l*g-f*m)+(T=i*h-s*a)*(C=p*y-v*d)-(A=i*c-o*a)*(B=p*g-f*d)+(P=s*c-o*h)*(U=p*m-l*d))&&(S=1/S,e[0]=(a*M-h*E+c*F)*S,e[1]=(s*E-i*M-o*F)*S,e[2]=(m*P-g*A+y*T)*S,e[3]=(f*A-l*P-v*T)*S,e[4]=(h*C-n*M-c*B)*S,e[5]=(r*M-s*C+o*B)*S,e[6]=(g*b-d*P-y*w)*S,e[7]=(p*P-f*b+v*w)*S,e[8]=(n*E-a*C+c*U)*S,e[9]=(i*C-r*E-o*U)*S,e[10]=(d*A-m*b+y*x)*S,e[11]=(l*b-p*A-v*x)*S,e[12]=(a*B-n*F-h*U)*S,e[13]=(r*F-i*B+s*U)*S,e[14]=(m*w-d*T-g*x)*S,e[15]=(p*T-l*w+f*x)*S),function(e,t){if(e===t){var r=t[1],i=t[2],s=t[3],o=t[6],n=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=r,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=o,e[11]=t[14],e[12]=s,e[13]=n,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]}(z,z),this.device.queue.writeBuffer(this.vertBuffer,0,G),this.device.queue.writeBuffer(this.vertBuffer,64,this.camera.view()),this.device.queue.writeBuffer(this.vertBuffer,128,this.camera.project()),this.device.queue.writeBuffer(this.vertBuffer,192,z);let N=new Float32Array(4);N[0]=this.light.pos[0],N[1]=this.light.pos[1],N[2]=this.light.pos[2],N[3]=1;let D=new Float32Array(4);D[0]=this.camera.eye[0],D[1]=this.camera.eye[1],D[2]=this.camera.eye[2],D[3]=1,this.device.queue.writeBuffer(this.fragBuffer,0,N),this.device.queue.writeBuffer(this.fragBuffer,16,D);const V=this.device.createCommandEncoder(),R=this.context.getCurrentTexture().createView(),q=this.colorTexture.createView(),O=V.beginRenderPass({colorAttachments:[{view:4==this.samples?q:R,resolveTarget:4==this.samples?R:void 0,clearValue:{r:.5,g:0,b:.25,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});O.setPipeline(this.pipeline),O.setBindGroup(0,this.bindGroup),O.setVertexBuffer(0,this.mesh.buffer),O.draw(this.mesh.idxCount,1,0,0),O.end(),this.device.queue.submit([V.finish()]),requestAnimationFrame(this.render),this.time+=this.timeStep},this.canvas=e,this.size[0]=e.clientWidth,this.size[1]=e.clientHeight,this.camera=new c(Math.PI/4,e.width,e.height,.1,10,[-5,0,2],[0,0,0],[0,0,1]),this.light=new p([1,2,0],[1,1,1])}initialize(){return l(this,void 0,void 0,(function*(){yield this.setupDevice(),this.createAssets(),yield this.mesh.createTexture(this.device,"https://imgs.smoothradio.com/images/191589?width=1200&crop=1_1&signature=KHg-WnaLlH9KsZwE-qYgxTkaSpU="),yield this.makePipeline(),requestAnimationFrame(this.render)}))}waitForTexture(){void 0!==this.mesh.texture?this.mesh.texture?console.log("Texture Loaded"):console.log("Texture Not Loaded"):setTimeout(this.waitForTexture,250)}setupDevice(){return l(this,void 0,void 0,(function*(){if(yield this.secureAdapter(),!this.adapter)return!1;for(;!this.device;)if(yield this.secureAdapter(),!this.adapter)return!1;this.context=this.canvas.getContext("webgpu"),this.format="bgra8unorm",this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}))}secureAdapter(){var e;return l(this,void 0,void 0,(function*(){if(!this.adapter&&(this.adapter=yield null===(e=navigator.gpu)||void 0===e?void 0:e.requestAdapter(),!this.adapter))return null;this.device=yield this.adapter.requestDevice(),this.device.lost.then((e=>{console.error("Device was lost.",e),this.setupDevice()}))}))}makePipeline(){return l(this,void 0,void 0,(function*(){this.vertBuffer=this.device.createBuffer({size:256,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.fragBuffer=this.device.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const e=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),t=this.device.createSampler({magFilter:"linear",minFilter:"linear"});console.log("TEXTURE NEEDED"),yield this.waitForTexture(),this.bindGroup=this.device.createBindGroup({layout:e,entries:[{binding:0,resource:{buffer:this.vertBuffer,size:256,offset:0}},{binding:1,resource:{buffer:this.fragBuffer,size:32,offset:0}},{binding:2,resource:t},{binding:3,resource:this.mesh.texture.texture.createView()}]});const r=this.device.createPipelineLayout({bindGroupLayouts:[e]});this.pipeline=this.device.createRenderPipeline({layout:r,vertex:{module:this.device.createShaderModule({code:"struct TransformData {\r\n    model: mat4x4<f32>,\r\n    view: mat4x4<f32>,\r\n    projection: mat4x4<f32>,\r\n    normal: mat4x4<f32>\r\n};\r\n\r\n@binding(0) @group(0) var<uniform> transform: TransformData;\r\n\r\nstruct Fragment {\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) Normal : vec4<f32>,\r\n    @location(1) UV: vec2<f32>,\r\n    @location(2) NormalizedPos : vec4<f32>\r\n};\r\n\r\n@vertex\r\nfn vs_main(@location(0) pos: vec3<f32>, @location(1) nor: vec3<f32>, @location(2) uv: vec2<f32>) -> Fragment {\r\n    var output : Fragment;\r\n    output.Position = transform.projection * transform.view * transform.model * vec4<f32>(pos, 1.0);\r\n    output.Normal = transform.normal * vec4<f32>(nor, 0.0);\r\n    output.UV = uv;\r\n    output.NormalizedPos = 0.5 * (vec4(pos, 0.0) + vec4(1.0, 1.0, 1.0, 1.0));\r\n    return output;\r\n}"}),entryPoint:"vs_main",buffers:[this.mesh.bufferLayout]},fragment:{module:this.device.createShaderModule({code:"struct Uniforms {\r\n            lightPos : vec4<f32>, \r\n            eyePos : vec4<f32>,\r\n        };\r\n\r\n@group(0) @binding(1) var<uniform> uniforms: Uniforms;\r\n@group(0) @binding(2) var textureSampler: sampler;\r\n@group(0) @binding(3) var texture: texture_2d<f32>;\r\n\r\n@fragment\r\nfn fs_main(\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) Normal: vec4<f32>,\r\n    @location(1) UV: vec2<f32>,\r\n    @location(2) NormalizedPos : vec4<f32>\r\n) -> @location(0) vec4<f32> {\r\n    var textureColor : vec4<f32> = textureSample(texture, textureSampler, UV);\r\n    var lambert : f32 = max(dot(Normal.xyz, normalize(uniforms.eyePos.xyz - Position.xyz)), 0.0);\r\n    var ambient : f32 = 0.25; \r\n\r\n    return vec4<f32>(textureColor.xyz * (lambert + ambient), 1.0);\r\n}"}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-list"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},multisample:{count:this.samples}}),this.depthTexture=this.device.createTexture({size:this.size,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.samples}),this.colorTexture=this.device.createTexture({size:this.size,sampleCount:this.samples,format:this.format,usage:GPUTextureUsage.RENDER_ATTACHMENT})}))}createAssets(){this.mesh=new t(this.device)}}(f);v.initialize()})();