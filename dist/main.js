(()=>{"use strict";class t{constructor(t){this.vertCount=0,this.idxCount=0,this.positions=new Array,this.colors=new Array,this.faces=new Array,this.createCube(),this.populateVBO();const e=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,s={size:this.vertDataVBO.byteLength,usage:e,mappedAtCreation:!0};this.buffer=t.createBuffer(s),new Float32Array(this.buffer.getMappedRange()).set(this.vertDataVBO),this.buffer.unmap(),this.bufferLayout={arrayStride:24,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12}]}}addVertex(t){console.log("adding vertex"),console.log(t.pos),console.log(t.col),this.positions.push(t.pos),this.colors.push(t.col),this.vertCount++}addFace(t,s){let i=new Array;for(let e=0;e<t.length;e++)i.push(this.vertCount),this.addVertex(t[e]);s?this.faces.push(new e(i,s)):this.faces.push(new e(i))}addFaceIndices(t,s){s?this.faces.push(new e(t,s)):this.faces.push(new e(t))}populateVBO(){var t=new Array;for(let e=0;e<this.faces.length;e++){const s=this.faces[e];for(let e=0;e<s.vertCount-2;e++){const i=null!=s.color?s.color:this.colors[s.verts[0]],r=null!=s.color?s.color:this.colors[s.verts[e+1]],o=null!=s.color?s.color:this.colors[s.verts[e+2]];t.push(this.positions[s.verts[0]][0]),t.push(this.positions[s.verts[0]][1]),t.push(this.positions[s.verts[0]][2]),t.push(i[0]),t.push(i[1]),t.push(i[2]),t.push(this.positions[s.verts[e+1]][0]),t.push(this.positions[s.verts[e+1]][1]),t.push(this.positions[s.verts[e+1]][2]),t.push(r[0]),t.push(r[1]),t.push(r[2]),t.push(this.positions[s.verts[e+2]][0]),t.push(this.positions[s.verts[e+2]][1]),t.push(this.positions[s.verts[e+2]][2]),t.push(o[0]),t.push(o[1]),t.push(o[2]),this.idxCount+=3,console.log("Adding Triangle"),console.log([0,e+1,e+2]),console.log([s.verts[0],s.verts[e+1],s.verts[e+2]])}}this.vertDataVBO=new Float32Array(t),console.log(this.vertCount),console.log(this.idxCount)}createCube(){let t=new Array;t.push({pos:[-1,-1,-1],col:[0,1,0],uv:void 0}),t.push({pos:[1,-1,-1],col:[1,0,0],uv:void 0}),t.push({pos:[1,1,-1],col:[0,0,1],uv:void 0}),t.push({pos:[-1,1,-1],col:[0,1,1],uv:void 0});let e=new Array;e.push({pos:[-1,-1,1],col:[0,1,0],uv:void 0}),e.push({pos:[1,-1,1],col:[1,0,0],uv:void 0}),e.push({pos:[1,1,1],col:[0,0,1],uv:void 0}),e.push({pos:[-1,1,1],col:[0,1,1],uv:void 0});let s=new Array;s.push({pos:[-1,-1,-1],col:[0,1,0],uv:void 0}),s.push({pos:[1,-1,-1],col:[1,0,0],uv:void 0}),s.push({pos:[1,-1,1],col:[0,0,1],uv:void 0}),s.push({pos:[-1,-1,1],col:[0,1,1],uv:void 0});let i=new Array;i.push({pos:[-1,1,-1],col:[0,1,0],uv:void 0}),i.push({pos:[1,1,-1],col:[1,0,0],uv:void 0}),i.push({pos:[1,1,1],col:[0,0,1],uv:void 0}),i.push({pos:[-1,1,1],col:[0,1,1],uv:void 0});let r=new Array;r.push({pos:[-1,-1,-1],col:[0,1,0],uv:void 0}),r.push({pos:[-1,1,-1],col:[1,0,0],uv:void 0}),r.push({pos:[-1,1,1],col:[0,0,1],uv:void 0}),r.push({pos:[-1,-1,1],col:[0,1,1],uv:void 0});let o=new Array;o.push({pos:[1,-1,-1],col:[0,1,0],uv:void 0}),o.push({pos:[1,1,-1],col:[1,0,0],uv:void 0}),o.push({pos:[1,1,1],col:[0,0,1],uv:void 0}),o.push({pos:[1,-1,1],col:[0,1,1],uv:void 0}),this.addFace(t,[1,0,0]),this.addFace(e,[0,1,0]),this.addFace(s,[0,0,1]),this.addFace(i,[1,0,1]),this.addFace(r,[1,1,0]),this.addFace(o,[0,1,1])}}class e{constructor(t,e){this.vertCount=0,this.verts=new Array;for(let e=0;e<t.length;e++)this.verts.push(t[e]);e&&(this.color=e),this.vertCount=t.length}addVertex(t){this.verts.push(t),this.vertCount++}}var s,i=1e-6,r="undefined"!=typeof Float32Array?Float32Array:Array;function o(){var t=new r(3);return r!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function n(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function a(t,e){var s=e[0],i=e[1],r=e[2],o=s*s+i*i+r*r;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t}function h(){var t=new r(16);return r!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)}),o(),s=new r(2),r!=Float32Array&&(s[0]=0,s[1]=0);class u{constructor(t,e,s,i,h,u,c,p){var l,v,d;this.eye=o(),this.ref=o(),this.up=o(),this.right=o(),this.look=o(),this.fovy=t,this.aspect=(l=e,v=s,(d=new r(2))[0]=l,d[1]=v,d),this.nearClip=i,this.farClip=h,n(this.eye,u),n(this.ref,c),n(this.up,p),a(this.up,this.up),function(t,e,s){t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2]}(this.look,c,u),a(this.look,this.look),function(t,e,s){var i=e[0],r=e[1],o=e[2],n=s[0],a=s[1],h=s[2];t[0]=r*h-o*a,t[1]=o*n-i*h,t[2]=i*a-r*n}(this.right,this.look,p),a(this.right,this.right)}project(){var t=h();return function(t,e,s,i,r){var o,n=1/Math.tan(e/2);t[0]=n/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(o=1/(i-r),t[10]=(r+i)*o,t[14]=2*r*i*o):(t[10]=-1,t[14]=-2*i)}(t,this.fovy,this.aspect[0]/this.aspect[1],this.nearClip,this.farClip),t}view(){var t=h();return function(t,e,s,r){var o,n,a,h,u,c,p,l,v,d,f=e[0],m=e[1],g=e[2],y=r[0],w=r[1],A=r[2],C=s[0],b=s[1],x=s[2];Math.abs(f-C)<i&&Math.abs(m-b)<i&&Math.abs(g-x)<i?function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(t):(p=f-C,l=m-b,v=g-x,o=w*(v*=d=1/Math.hypot(p,l,v))-A*(l*=d),n=A*(p*=d)-y*v,a=y*l-w*p,(d=Math.hypot(o,n,a))?(o*=d=1/d,n*=d,a*=d):(o=0,n=0,a=0),h=l*a-v*n,u=v*o-p*a,c=p*n-l*o,(d=Math.hypot(h,u,c))?(h*=d=1/d,u*=d,c*=d):(h=0,u=0,c=0),t[0]=o,t[1]=h,t[2]=p,t[3]=0,t[4]=n,t[5]=u,t[6]=l,t[7]=0,t[8]=a,t[9]=c,t[10]=v,t[11]=0,t[12]=-(o*f+n*m+a*g),t[13]=-(h*f+u*m+c*g),t[14]=-(p*f+l*m+v*g),t[15]=1)}(t,this.eye,this.ref,this.up),t}model(t){var e=h();return function(t,e,s,r){var o,n,a,h,u,c,p,l,v,d,f,m,g,y,w,A,C,b,x,B,M,P,F,T,V=r[0],D=r[1],U=r[2],E=Math.hypot(V,D,U);E<i||(V*=E=1/E,D*=E,U*=E,o=Math.sin(s),a=1-(n=Math.cos(s)),h=e[0],u=e[1],c=e[2],p=e[3],l=e[4],v=e[5],d=e[6],f=e[7],m=e[8],g=e[9],y=e[10],w=e[11],A=V*V*a+n,C=D*V*a+U*o,b=U*V*a-D*o,x=V*D*a-U*o,B=D*D*a+n,M=U*D*a+V*o,P=V*U*a+D*o,F=D*U*a-V*o,T=U*U*a+n,t[0]=h*A+l*C+m*b,t[1]=u*A+v*C+g*b,t[2]=c*A+d*C+y*b,t[3]=p*A+f*C+w*b,t[4]=h*x+l*B+m*M,t[5]=u*x+v*B+g*M,t[6]=c*x+d*B+y*M,t[7]=p*x+f*B+w*M,t[8]=h*P+l*F+m*T,t[9]=u*P+v*F+g*T,t[10]=c*P+d*F+y*T,t[11]=p*P+f*F+w*T,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]))}(e,e,t,[0,0,1]),e}}var c=function(t,e,s,i){return new(s||(s=Promise))((function(r,o){function n(t){try{h(i.next(t))}catch(t){o(t)}}function a(t){try{h(i.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(n,a)}h((i=i.apply(t,e||[])).next())}))};const p=document.getElementById("gfx-main"),l=new class{constructor(t){this.size=new Array(2),this.time=0,this.timeStep=.01,this.samples=1,this.render=()=>{this.device.queue.writeBuffer(this.uniformBuffer,0,this.camera.model(this.time)),this.device.queue.writeBuffer(this.uniformBuffer,64,this.camera.view()),this.device.queue.writeBuffer(this.uniformBuffer,128,this.camera.project());const t=this.device.createTexture({size:this.size,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.samples}),e=this.device.createCommandEncoder(),s=this.context.getCurrentTexture().createView(),i=this.device.createTexture({size:this.size,sampleCount:this.samples,format:this.format,usage:GPUTextureUsage.RENDER_ATTACHMENT}).createView(),r=e.beginRenderPass({colorAttachments:[{view:4==this.samples?i:s,resolveTarget:4==this.samples?s:void 0,clearValue:{r:.5,g:0,b:.25,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:t.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});r.setPipeline(this.pipeline),r.setBindGroup(0,this.bindGroup),r.setVertexBuffer(0,this.mesh.buffer),r.draw(this.mesh.idxCount,1,0,0),r.end(),this.device.queue.submit([e.finish()]),requestAnimationFrame(this.render),this.time+=this.timeStep},this.canvas=t,this.size[0]=t.clientWidth,this.size[1]=t.clientHeight,this.camera=new u(Math.PI/4,t.width,t.height,.1,10,[-5,0,2],[0,0,0],[0,0,1])}initialize(){return c(this,void 0,void 0,(function*(){yield this.setupDevice(),this.createAssets(),yield this.makePipeline(),requestAnimationFrame(this.render)}))}setupDevice(){return c(this,void 0,void 0,(function*(){if(yield this.secureAdapter(),!this.adapter)return!1;for(;!this.device;)if(yield this.secureAdapter(),!this.adapter)return!1;this.context=this.canvas.getContext("webgpu"),this.format="bgra8unorm",this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}))}secureAdapter(){var t;return c(this,void 0,void 0,(function*(){if(!this.adapter&&(this.adapter=yield null===(t=navigator.gpu)||void 0===t?void 0:t.requestAdapter(),!this.adapter))return null;this.device=yield this.adapter.requestDevice(),this.device.lost.then((t=>{console.error("Device was lost.",t),this.setupDevice()}))}))}makePipeline(){return c(this,void 0,void 0,(function*(){this.uniformBuffer=this.device.createBuffer({size:192,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const t=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]});this.bindGroup=this.device.createBindGroup({layout:t,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]});const e=this.device.createPipelineLayout({bindGroupLayouts:[t]});this.pipeline=this.device.createRenderPipeline({layout:e,vertex:{module:this.device.createShaderModule({code:"struct TransformData {\r\n    model: mat4x4<f32>,\r\n    view: mat4x4<f32>,\r\n    projection: mat4x4<f32>\r\n};\r\n\r\n@binding(0) @group(0) var<uniform> transform: TransformData;\r\n\r\nstruct Fragment {\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) Color : vec4<f32>\r\n};\r\n\r\n@vertex\r\nfn vs_main(@location(0) pos: vec3<f32>, @location(1) col: vec3<f32>) -> Fragment {\r\n    var output : Fragment;\r\n    output.Position = transform.projection * transform.view * transform.model * vec4<f32>(pos, 1.0);\r\n    output.Color = vec4<f32>(col, 1.0);\r\n    return output;\r\n}"}),entryPoint:"vs_main",buffers:[this.mesh.bufferLayout]},fragment:{module:this.device.createShaderModule({code:"@fragment\r\nfn fs_main(\r\n    @location(0) Color: vec4<f32>\r\n) -> @location(0) vec4<f32> {\r\n    return Color;\r\n}"}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-list"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},multisample:{count:this.samples}})}))}createAssets(){this.mesh=new t(this.device)}}(p);l.initialize()})();