(()=>{"use strict";var t={d:(e,i)=>{for(var r in i)t.o(i,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:i[r]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};t.d({},{R1:()=>C,J_:()=>D,QR:()=>M,an:()=>R,qf:()=>G});var e=1e-6,i="undefined"!=typeof Float32Array?Float32Array:Array;function r(){var t=new i(3);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function s(t,e,r){var s=new i(3);return s[0]=t,s[1]=e,s[2]=r,s}function o(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function n(t,e,i,r){return t[0]=e,t[1]=i,t[2]=r,t}function h(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function a(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function u(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function l(t,e){var i=e[0],r=e[1],s=e[2],o=i*i+r*r+s*s;return o>0&&(o=1/Math.sqrt(o)),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o,t}function c(t,e,i){var r=e[0],s=e[1],o=e[2],n=i[0],h=i[1],a=i[2];return t[0]=s*a-o*h,t[1]=o*n-r*a,t[2]=r*h-s*n,t}function f(t,e,i){var r=i[0],s=i[1],o=i[2],n=i[3],h=e[0],a=e[1],u=e[2],l=s*u-o*a,c=o*h-r*u,f=r*a-s*h,p=s*f-o*c,d=o*l-r*f,v=r*c-s*l,m=2*n;return l*=m,c*=m,f*=m,p*=2,d*=2,v*=2,t[0]=h+l+p,t[1]=a+c+d,t[2]=u+f+v,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});function p(){var t=new i(16);return i!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function d(t,e,i){var r,s,o,n,h,a,u,l,c,f,p,d,v=i[0],m=i[1],g=i[2];return e===t?(t[12]=e[0]*v+e[4]*m+e[8]*g+e[12],t[13]=e[1]*v+e[5]*m+e[9]*g+e[13],t[14]=e[2]*v+e[6]*m+e[10]*g+e[14],t[15]=e[3]*v+e[7]*m+e[11]*g+e[15]):(r=e[0],s=e[1],o=e[2],n=e[3],h=e[4],a=e[5],u=e[6],l=e[7],c=e[8],f=e[9],p=e[10],d=e[11],t[0]=r,t[1]=s,t[2]=o,t[3]=n,t[4]=h,t[5]=a,t[6]=u,t[7]=l,t[8]=c,t[9]=f,t[10]=p,t[11]=d,t[12]=r*v+h*m+c*g+e[12],t[13]=s*v+a*m+f*g+e[13],t[14]=o*v+u*m+p*g+e[14],t[15]=n*v+l*m+d*g+e[15]),t}function v(t,i,r,s){var o,n,h,a,u,l,c,f,p,d,v,m,g,y,w,x,b,k,A,T,P,B,S,U,E=s[0],F=s[1],C=s[2],M=Math.hypot(E,F,C);return M<e?null:(E*=M=1/M,F*=M,C*=M,o=Math.sin(r),h=1-(n=Math.cos(r)),a=i[0],u=i[1],l=i[2],c=i[3],f=i[4],p=i[5],d=i[6],v=i[7],m=i[8],g=i[9],y=i[10],w=i[11],x=E*E*h+n,b=F*E*h+C*o,k=C*E*h-F*o,A=E*F*h-C*o,T=F*F*h+n,P=C*F*h+E*o,B=E*C*h+F*o,S=F*C*h-E*o,U=C*C*h+n,t[0]=a*x+f*b+m*k,t[1]=u*x+p*b+g*k,t[2]=l*x+d*b+y*k,t[3]=c*x+v*b+w*k,t[4]=a*A+f*T+m*P,t[5]=u*A+p*T+g*P,t[6]=l*A+d*T+y*P,t[7]=c*A+v*T+w*P,t[8]=a*B+f*S+m*U,t[9]=u*B+p*S+g*U,t[10]=l*B+d*S+y*U,t[11]=c*B+v*S+w*U,i!==t&&(t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t)}r();class m{constructor(t){this.texture=void 0,this.sampler=void 0,this.bitmap=void 0,this.filepath=void 0,this.filepath=t}setFilepath(t){this.filepath=t}create(t){return e=this,i=void 0,s=function*(){const e=document.createElement("img");e.src=new URL(this.filepath,"file:///C:/Users/eyada/Documents/webgpu-impact/src/types/texture.ts").toString(),yield e.decode();const i=yield fetch(this.filepath);if(!i.ok)return console.error("Network error",i.status);const r=yield i.blob();this.bitmap=yield createImageBitmap(r),console.log(this.bitmap),this.texture=t.createTexture({size:[this.bitmap.width,this.bitmap.height],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),t.queue.copyExternalImageToTexture({source:this.bitmap},{texture:this.texture},[this.bitmap.width,this.bitmap.height])},new((r=void 0)||(r=Promise))((function(t,o){function n(t){try{a(s.next(t))}catch(t){o(t)}}function h(t){try{a(s.throw(t))}catch(t){o(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof r?i:new r((function(t){t(i)}))).then(n,h)}a((s=s.apply(e,i||[])).next())}));var e,i,r,s}}class g{constructor(t){this.vertCount=0,this.idxCount=0,this.positions=new Array,this.normals=new Array,this.uvs=new Array,this.faces=new Array,this.texture=void 0,this.translate=r(),this.rotate=r(),this.createCube(),this.populateVBO();const e=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,i={size:this.vertDataVBO.byteLength,usage:e,mappedAtCreation:!0};this.buffer=t.createBuffer(i),new Float32Array(this.buffer.getMappedRange()).set(this.vertDataVBO),this.buffer.unmap(),this.bufferLayout={arrayStride:32,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12},{shaderLocation:2,format:"float32x2",offset:24}]}}createTexture(t,e){return i=this,r=void 0,o=function*(){this.texture=new m(e),yield this.texture.create(t)},new((s=void 0)||(s=Promise))((function(t,e){function n(t){try{a(o.next(t))}catch(t){e(t)}}function h(t){try{a(o.throw(t))}catch(t){e(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(n,h)}a((o=o.apply(i,r||[])).next())}));var i,r,s,o}addVertex(t){console.log("adding vertex"),console.log(t.pos),console.log(t.nor),console.log(t.uv),this.positions.push(t.pos),this.normals.push(t.nor),this.uvs.push(t.uv),this.vertCount++}addFace(t){let e=new Array;for(let i=0;i<t.length;i++)e.push(this.vertCount),this.addVertex(t[i]);this.faces.push(new y(e))}addFaceIndices(t){this.faces.push(new y(t))}rotateMesh(){this.rotate[1]+=.01}populateVBO(){var t=new Array;for(let e=0;e<this.faces.length;e++){const i=this.faces[e];for(let e=0;e<i.vertCount-2;e++){const r=this.positions[i.verts[0]],s=this.positions[i.verts[e+1]],o=this.positions[i.verts[e+2]],n=this.normals[i.verts[0]],h=this.normals[i.verts[e+1]],a=this.normals[i.verts[e+2]],u=this.uvs[i.verts[0]],l=this.uvs[i.verts[e+1]],c=this.uvs[i.verts[e+2]];t.push(r[0]),t.push(r[1]),t.push(r[2]),t.push(n[0]),t.push(n[1]),t.push(n[2]),t.push(u[0]),t.push(u[1]),t.push(s[0]),t.push(s[1]),t.push(s[2]),t.push(h[0]),t.push(h[1]),t.push(h[2]),t.push(l[0]),t.push(l[1]),t.push(o[0]),t.push(o[1]),t.push(o[2]),t.push(a[0]),t.push(a[1]),t.push(a[2]),t.push(c[0]),t.push(c[1]),this.idxCount+=3,console.log("Adding Triangle"),console.log([0,e+1,e+2]),console.log([i.verts[0],i.verts[e+1],i.verts[e+2]])}}this.vertDataVBO=new Float32Array(t),console.log(this.vertCount),console.log(this.idxCount)}getModelMatrix(){let t=p();return v(t,t,this.rotate[0],[1,0,0]),v(t,t,this.rotate[1],[0,1,0]),v(t,t,this.rotate[2],[0,0,1]),d(t,t,this.translate),t}createCube(){let t=new Array;t.push({pos:[-1,-1,-1],nor:[0,0,-1],uv:[0,0]}),t.push({pos:[1,-1,-1],nor:[0,0,-1],uv:[0,1]}),t.push({pos:[1,1,-1],nor:[0,0,-1],uv:[1,1]}),t.push({pos:[-1,1,-1],nor:[0,0,-1],uv:[1,0]});let e=new Array;e.push({pos:[-1,-1,1],nor:[0,0,1],uv:[0,0]}),e.push({pos:[1,-1,1],nor:[0,0,1],uv:[0,1]}),e.push({pos:[1,1,1],nor:[0,0,1],uv:[1,1]}),e.push({pos:[-1,1,1],nor:[0,0,1],uv:[1,0]});let i=new Array;i.push({pos:[-1,-1,-1],nor:[0,-1,0],uv:[0,0]}),i.push({pos:[1,-1,-1],nor:[0,-1,0],uv:[0,1]}),i.push({pos:[1,-1,1],nor:[0,-1,0],uv:[1,1]}),i.push({pos:[-1,-1,1],nor:[0,-1,0],uv:[1,0]});let r=new Array;r.push({pos:[-1,1,-1],nor:[0,1,0],uv:[0,0]}),r.push({pos:[1,1,-1],nor:[0,1,0],uv:[0,1]}),r.push({pos:[1,1,1],nor:[0,1,0],uv:[1,1]}),r.push({pos:[-1,1,1],nor:[0,1,0],uv:[1,0]});let s=new Array;s.push({pos:[-1,-1,-1],nor:[-1,0,0],uv:[0,0]}),s.push({pos:[-1,1,-1],nor:[-1,0,0],uv:[0,1]}),s.push({pos:[-1,1,1],nor:[-1,0,0],uv:[1,1]}),s.push({pos:[-1,-1,1],nor:[-1,0,0],uv:[1,0]});let o=new Array;o.push({pos:[1,-1,-1],nor:[1,0,0],uv:[0,0]}),o.push({pos:[1,1,-1],nor:[1,0,0],uv:[0,1]}),o.push({pos:[1,1,1],nor:[1,0,0],uv:[1,1]}),o.push({pos:[1,-1,1],nor:[1,0,0],uv:[1,0]}),this.addFace(t),this.addFace(e),this.addFace(i),this.addFace(r),this.addFace(s),this.addFace(o)}}class y{constructor(t){this.vertCount=0,this.verts=new Array;for(let e=0;e<t.length;e++)this.verts.push(t[e]);this.vertCount=t.length}addVertex(t){this.verts.push(t),this.vertCount++}}function w(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function x(t,e,i,r,s){return t[0]=e,t[1]=i,t[2]=r,t[3]=s,t}function b(t,e,i){var r=e[0],s=e[1],o=e[2],n=e[3];return t[0]=i[0]*r+i[4]*s+i[8]*o+i[12]*n,t[1]=i[1]*r+i[5]*s+i[9]*o+i[13]*n,t[2]=i[2]*r+i[6]*s+i[10]*o+i[14]*n,t[3]=i[3]*r+i[7]*s+i[11]*o+i[15]*n,t}function k(){var t=new i(4);return i!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function A(t,e,i){i*=.5;var r=Math.sin(i);return t[0]=r*e[0],t[1]=r*e[1],t[2]=r*e[2],t[3]=Math.cos(i),t}!function(){var t;t=new i(2),i!=Float32Array&&(t[0]=0,t[1]=0)}(),w();var T;r(),s(1,0,0),s(0,1,0),k(),k(),T=new i(9),i!=Float32Array&&(T[1]=0,T[2]=0,T[3]=0,T[5]=0,T[6]=0,T[7]=0),T[0]=1,T[4]=1,T[8]=1;class P{constructor(t,e,s,n,h,u,f,p){this.eye=r(),this.ref=r(),this.up=r(),this.right=r(),this.look=r(),this.theta=0,this.phi=0,this.fovy=t,this.aspect=function(t,e){var r=new i(2);return r[0]=t,r[1]=e,r}(e,s),this.nearClip=n,this.farClip=h,o(this.eye,u),o(this.ref,f),o(this.up,p),l(this.up,this.up),a(this.look,f,u),l(this.look,this.look),c(this.right,p,this.look),l(this.right,this.right)}calculateRotation(){let t=r();n(t,1,0,0);let e=r();n(e,0,1,0);let i=p();v(i,i,this.phi,t);let s=p();v(s,s,this.theta,e);let o=w();x(o,0,0,1,0),b(o,o,s),b(o,o,i),n(this.look,o[0],o[1],o[2]);let a=w();x(a,0,1,0,0),b(a,a,i),n(this.up,a[0],a[1],a[2]),c(this.right,this.look,this.up),l(this.look,this.look),l(this.up,this.up),l(this.right,this.right),h(this.ref,this.eye,this.look)}updateAttributes(t,e){let i=.1*e;var s;if(t.up&&(A(s=w(),this.right,i),f(this.up,this.up,s),f(this.look,this.look,s)),t.down&&(A(s=w(),this.right,-i),f(this.up,this.up,s),f(this.look,this.look,s)),t.left&&(A(s=w(),this.up,i),f(this.right,this.right,s),f(this.look,this.look,s)),t.right&&(A(s=w(),this.up,-i),f(this.right,this.right,s),f(this.look,this.look,s)),t.w){let t=r();u(t,this.look,e),h(this.eye,this.eye,t),h(this.ref,this.eye,this.look)}if(t.d){let t=r();u(t,this.right,e),a(this.eye,this.eye,t),h(this.ref,this.eye,this.look)}if(t.s){let t=r();u(t,this.look,e),a(this.eye,this.eye,t),h(this.ref,this.eye,this.look)}if(t.a){let t=r();u(t,this.right,e),h(this.eye,this.eye,t),h(this.ref,this.eye,this.look)}if(t.e){let t=r();n(t,0,e,0),h(this.eye,this.eye,t),h(this.ref,this.eye,this.look)}if(t.q){let t=r();u(t,this.up,e),a(this.eye,this.eye,t),h(this.ref,this.eye,this.look)}C.innerText="EYE : "+String(this.eye[0])+", "+String(this.eye[1])+", "+String(this.eye[2]),M.innerText="REF : "+String(this.ref[0])+", "+String(this.ref[1])+", "+String(this.ref[2]),D.innerText="LOOK : "+String(this.look[0])+", "+String(this.look[1])+", "+String(this.look[2]),G.innerText="UP : "+String(this.up[0])+", "+String(this.up[1])+", "+String(this.up[2]),R.innerText="RIGHT : "+String(this.right[0])+", "+String(this.right[1])+", "+String(this.right[2])}project(){var t=p();return function(t,e,i,r,s){var o,n=1/Math.tan(e/2);t[0]=n/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=s&&s!==1/0?(o=1/(r-s),t[10]=(s+r)*o,t[14]=2*s*r*o):(t[10]=-1,t[14]=-2*r)}(t,this.fovy,this.aspect[0]/this.aspect[1],this.nearClip,this.farClip),t}view(){var t=p();return function(t,e,i,r,s,o,n,h,a,u,l,c,f,p,d,v,m){t[0]=e,t[1]=i,t[2]=r,t[3]=0,t[4]=o,t[5]=n,t[6]=h,t[7]=0,t[8]=u,t[9]=l,t[10]=c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(t,this.right[0],this.up[0],this.look[0],0,this.right[1],this.up[1],this.look[1],0,this.right[2],this.up[2],this.look[2]),d(t,t,this.eye),t}model(t){var e=p();return v(e,e,t,[0,0,1]),e}}class B{constructor(t,e){this.pos=r(),this.col=r(),this.pos=t,this.col=e}}let S={up:!1,down:!1,left:!1,right:!1,w:!1,a:!1,s:!1,d:!1,q:!1,e:!1};var U=function(t,e,i,r){return new(i||(i=Promise))((function(s,o){function n(t){try{a(r.next(t))}catch(t){o(t)}}function h(t){try{a(r.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?s(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(n,h)}a((r=r.apply(t,e||[])).next())}))};const E=document.getElementById("gfx-main"),F=new class{constructor(t){this.size=new Array(2),this.time=0,this.timeStep=.01,this.samples=4,this.frame=()=>{this.camera.updateAttributes(S,.1),this.mesh.rotateMesh(),function(t,e,i,r){var s=[],o=[];s[0]=e[0]-i[0],s[1]=e[1]-i[1],s[2]=e[2]-i[2],o[0]=s[2]*Math.sin(r)+s[0]*Math.cos(r),o[1]=s[1],o[2]=s[2]*Math.cos(r)-s[0]*Math.sin(r),t[0]=o[0]+i[0],t[1]=o[1]+i[1],t[2]=o[2]+i[2]}(this.light.pos,this.light.pos,[0,0,0],this.timeStep),this.render(),requestAnimationFrame(this.frame),this.time+=this.timeStep},this.canvas=t,this.size[0]=t.clientWidth,this.size[1]=t.clientHeight,this.camera=new P(Math.PI/4,t.width,t.height,.1,50,[0,0,-5],[0,0,0],[0,1,0]),this.light=new B([0,0,5],[1,1,1])}initialize(){return U(this,void 0,void 0,(function*(){yield this.setupDevice(),this.createAssets(),yield this.mesh.createTexture(this.device,"https://imgs.smoothradio.com/images/191589?width=1200&crop=1_1&signature=KHg-WnaLlH9KsZwE-qYgxTkaSpU="),yield this.makePipeline(),requestAnimationFrame(this.frame)}))}waitForTexture(){void 0!==this.mesh.texture?this.mesh.texture?console.log("Texture Loaded"):console.log("Texture Not Loaded"):setTimeout(this.waitForTexture,250)}setupDevice(){return U(this,void 0,void 0,(function*(){if(yield this.secureAdapter(),!this.adapter)return!1;for(;!this.device;)if(yield this.secureAdapter(),!this.adapter)return!1;this.context=this.canvas.getContext("webgpu"),this.format="bgra8unorm",this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}))}secureAdapter(){var t;return U(this,void 0,void 0,(function*(){if(!this.adapter&&(this.adapter=yield null===(t=navigator.gpu)||void 0===t?void 0:t.requestAdapter(),!this.adapter))return null;this.device=yield this.adapter.requestDevice(),this.device.lost.then((t=>{console.error("Device was lost.",t),this.setupDevice()}))}))}makePipeline(){return U(this,void 0,void 0,(function*(){this.vertBuffer=this.device.createBuffer({size:256,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),this.fragBuffer=this.device.createBuffer({size:32,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const t=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,buffer:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),e=this.device.createSampler({magFilter:"linear",minFilter:"linear"});console.log("TEXTURE NEEDED"),yield this.waitForTexture(),this.bindGroup=this.device.createBindGroup({layout:t,entries:[{binding:0,resource:{buffer:this.vertBuffer,size:256,offset:0}},{binding:1,resource:{buffer:this.fragBuffer,size:32,offset:0}},{binding:2,resource:e},{binding:3,resource:this.mesh.texture.texture.createView()}]});const i=this.device.createPipelineLayout({bindGroupLayouts:[t]});this.pipeline=this.device.createRenderPipeline({layout:i,vertex:{module:this.device.createShaderModule({code:"struct TransformData {\r\n    model: mat4x4<f32>,\r\n    view: mat4x4<f32>,\r\n    projection: mat4x4<f32>,\r\n    normal: mat4x4<f32>\r\n};\r\n\r\n@binding(0) @group(0) var<uniform> transform: TransformData;\r\n\r\nstruct Fragment {\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) Normal : vec4<f32>,\r\n    @location(1) UV: vec2<f32>,\r\n    @location(2) NormalizedPos : vec4<f32>\r\n};\r\n\r\n@vertex\r\nfn vs_main(@location(0) pos: vec3<f32>, @location(1) nor: vec3<f32>, @location(2) uv: vec2<f32>) -> Fragment {\r\n    var output : Fragment;\r\n    output.Position = transform.projection * transform.view * transform.model * vec4<f32>(pos, 1.0);\r\n    output.Normal = transform.normal * vec4<f32>(nor, 0.0);\r\n    output.UV = uv;\r\n    output.NormalizedPos = 0.5 * (vec4(pos, 0.0) + vec4(1.0, 1.0, 1.0, 1.0));\r\n    return output;\r\n}"}),entryPoint:"vs_main",buffers:[this.mesh.bufferLayout]},fragment:{module:this.device.createShaderModule({code:"struct Uniforms {\r\n            lightPos : vec4<f32>, \r\n            eyePos : vec4<f32>,\r\n        };\r\n\r\n@group(0) @binding(1) var<uniform> uniforms: Uniforms;\r\n@group(0) @binding(2) var textureSampler: sampler;\r\n@group(0) @binding(3) var texture: texture_2d<f32>;\r\n\r\n@fragment\r\nfn fs_main(\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) Normal: vec4<f32>,\r\n    @location(1) UV: vec2<f32>,\r\n    @location(2) NormalizedPos : vec4<f32>\r\n) -> @location(0) vec4<f32> {\r\n    var textureColor : vec4<f32> = textureSample(texture, textureSampler, UV);\r\n    var lambert : f32 = max(dot(normalize(Normal.xyz), normalize(uniforms.lightPos.xyz - Position.xyz)), 0.0);\r\n    var ambient : f32 = 0.25; \r\n\r\n    var toonDim : f32 = 10.0;\r\n    var finalcolor : vec3<f32> = textureColor.xyz * (lambert + ambient);\r\n    finalcolor *= toonDim;\r\n    finalcolor = vec3<f32> (floor(finalcolor.x)/toonDim, floor(finalcolor.y)/toonDim, floor(finalcolor.z)/toonDim);\r\n\r\n    return vec4<f32>(finalcolor, 1.0);\r\n}"}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-list"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},multisample:{count:this.samples}}),this.depthTexture=this.device.createTexture({size:this.size,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.samples}),this.colorTexture=this.device.createTexture({size:this.size,sampleCount:this.samples,format:this.format,usage:GPUTextureUsage.RENDER_ATTACHMENT})}))}createAssets(){this.mesh=new g(this.device)}render(){var t=this.mesh.getModelMatrix(),e=p();!function(t,e){var i=e[0],r=e[1],s=e[2],o=e[3],n=e[4],h=e[5],a=e[6],u=e[7],l=e[8],c=e[9],f=e[10],p=e[11],d=e[12],v=e[13],m=e[14],g=e[15],y=i*h-r*n,w=i*a-s*n,x=i*u-o*n,b=r*a-s*h,k=r*u-o*h,A=s*u-o*a,T=l*v-c*d,P=l*m-f*d,B=l*g-p*d,S=c*m-f*v,U=c*g-p*v,E=f*g-p*m,F=y*E-w*U+x*S+b*B-k*P+A*T;F&&(F=1/F,t[0]=(h*E-a*U+u*S)*F,t[1]=(s*U-r*E-o*S)*F,t[2]=(v*A-m*k+g*b)*F,t[3]=(f*k-c*A-p*b)*F,t[4]=(a*B-n*E-u*P)*F,t[5]=(i*E-s*B+o*P)*F,t[6]=(m*x-d*A-g*w)*F,t[7]=(l*A-f*x+p*w)*F,t[8]=(n*U-h*B+u*T)*F,t[9]=(r*B-i*U-o*T)*F,t[10]=(d*k-v*x+g*y)*F,t[11]=(c*x-l*k-p*y)*F,t[12]=(h*P-n*S-a*T)*F,t[13]=(i*S-r*P+s*T)*F,t[14]=(v*w-d*b-m*y)*F,t[15]=(l*b-c*w+f*y)*F)}(e,t),function(t,e){if(t===e){var i=e[1],r=e[2],s=e[3],o=e[6],n=e[7],h=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=o,t[11]=e[14],t[12]=s,t[13]=n,t[14]=h}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15]}(e,e),this.device.queue.writeBuffer(this.vertBuffer,0,t),this.device.queue.writeBuffer(this.vertBuffer,64,this.camera.view()),this.device.queue.writeBuffer(this.vertBuffer,128,this.camera.project()),this.device.queue.writeBuffer(this.vertBuffer,192,e);let i=new Float32Array(4);i[0]=this.light.pos[0],i[1]=this.light.pos[1],i[2]=this.light.pos[2],i[3]=1;let r=new Float32Array(4);r[0]=this.camera.eye[0],r[1]=this.camera.eye[1],r[2]=this.camera.eye[2],r[3]=1,this.device.queue.writeBuffer(this.fragBuffer,0,i),this.device.queue.writeBuffer(this.fragBuffer,16,r);const s=this.device.createCommandEncoder(),o=this.context.getCurrentTexture().createView(),n=this.colorTexture.createView(),h=s.beginRenderPass({colorAttachments:[{view:4==this.samples?n:o,resolveTarget:4==this.samples?o:void 0,clearValue:{r:.5,g:0,b:.25,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:this.depthTexture.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});h.setPipeline(this.pipeline),h.setBindGroup(0,this.bindGroup),h.setVertexBuffer(0,this.mesh.buffer),h.draw(this.mesh.idxCount,1,0,0),h.end(),this.device.queue.submit([s.finish()])}}(E);document.addEventListener("keydown",(function(t){"ArrowUp"==t.key?S.up=!0:"ArrowDown"==t.key?S.down=!0:"ArrowLeft"==t.key?S.left=!0:"ArrowRight"==t.key?S.right=!0:"w"==t.key?S.w=!0:"a"==t.key?S.a=!0:"s"==t.key?S.s=!0:"d"==t.key?S.d=!0:"q"==t.key?S.q=!0:"e"==t.key&&(S.e=!0),console.log(S)}),!1),document.addEventListener("keyup",(function(t){"ArrowUp"==t.key?S.up=!1:"ArrowDown"==t.key?S.down=!1:"ArrowLeft"==t.key?S.left=!1:"ArrowRight"==t.key?S.right=!1:"w"==t.key?S.w=!1:"a"==t.key?S.a=!1:"s"==t.key?S.s=!1:"d"==t.key?S.d=!1:"q"==t.key?S.q=!1:"e"==t.key&&(S.e=!1),console.log(S)}),!1),F.initialize();const C=document.getElementById("eye"),M=document.getElementById("ref"),D=document.getElementById("look"),G=document.getElementById("up"),R=document.getElementById("right")})();