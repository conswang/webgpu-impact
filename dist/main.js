(()=>{"use strict";class e{constructor(e){this.texture=void 0,this.sampler=void 0,this.bitmap=void 0,this.filepath=void 0,this.filepath=e}setFilepath(e){this.filepath=e}create(e){return t=this,r=void 0,i=function*(){const t=document.createElement("img");t.src=new URL(this.filepath,"file:///C:/Users/eyada/Desktop/webgpu-impact/src/types/texture.ts").toString(),yield t.decode();const r=yield fetch(this.filepath);if(!r.ok)return console.error("Network error",r.status);const s=yield r.blob();this.bitmap=yield createImageBitmap(s),console.log(this.bitmap),this.texture=e.createTexture({size:[this.bitmap.width,this.bitmap.height],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT}),e.queue.copyExternalImageToTexture({source:this.bitmap},{texture:this.texture},[this.bitmap.width,this.bitmap.height])},new((s=void 0)||(s=Promise))((function(e,o){function n(e){try{u(i.next(e))}catch(e){o(e)}}function a(e){try{u(i.throw(e))}catch(e){o(e)}}function u(t){var r;t.done?e(t.value):(r=t.value,r instanceof s?r:new s((function(e){e(r)}))).then(n,a)}u((i=i.apply(t,r||[])).next())}));var t,r,s,i}}class t{constructor(e){this.vertCount=0,this.idxCount=0,this.positions=new Array,this.normals=new Array,this.uvs=new Array,this.faces=new Array,this.texture=void 0,this.createCube(),this.populateVBO();const t=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,r={size:this.vertDataVBO.byteLength,usage:t,mappedAtCreation:!0};this.buffer=e.createBuffer(r),new Float32Array(this.buffer.getMappedRange()).set(this.vertDataVBO),this.buffer.unmap(),this.bufferLayout={arrayStride:32,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12},{shaderLocation:2,format:"float32x2",offset:24}]}}createTexture(t,r){return s=this,i=void 0,n=function*(){this.texture=new e(r),yield this.texture.create(t)},new((o=void 0)||(o=Promise))((function(e,t){function r(e){try{u(n.next(e))}catch(e){t(e)}}function a(e){try{u(n.throw(e))}catch(e){t(e)}}function u(t){var s;t.done?e(t.value):(s=t.value,s instanceof o?s:new o((function(e){e(s)}))).then(r,a)}u((n=n.apply(s,i||[])).next())}));var s,i,o,n}addVertex(e){console.log("adding vertex"),console.log(e.pos),console.log(e.nor),console.log(e.uv),this.positions.push(e.pos),this.normals.push(e.nor),this.uvs.push(e.uv),this.vertCount++}addFace(e){let t=new Array;for(let r=0;r<e.length;r++)t.push(this.vertCount),this.addVertex(e[r]);this.faces.push(new r(t))}addFaceIndices(e){this.faces.push(new r(e))}populateVBO(){var e=new Array;for(let t=0;t<this.faces.length;t++){const r=this.faces[t];for(let t=0;t<r.vertCount-2;t++){const s=this.positions[r.verts[0]],i=this.positions[r.verts[t+1]],o=this.positions[r.verts[t+2]],n=this.normals[r.verts[0]],a=this.normals[r.verts[t+1]],u=this.normals[r.verts[t+2]],h=this.uvs[r.verts[0]],c=this.uvs[r.verts[t+1]],p=this.uvs[r.verts[t+2]];e.push(s[0]),e.push(s[1]),e.push(s[2]),e.push(n[0]),e.push(n[1]),e.push(n[2]),e.push(h[0]),e.push(h[1]),e.push(i[0]),e.push(i[1]),e.push(i[2]),e.push(a[0]),e.push(a[1]),e.push(a[2]),e.push(c[0]),e.push(c[1]),e.push(o[0]),e.push(o[1]),e.push(o[2]),e.push(u[0]),e.push(u[1]),e.push(u[2]),e.push(p[0]),e.push(p[1]),this.idxCount+=3,console.log("Adding Triangle"),console.log([0,t+1,t+2]),console.log([r.verts[0],r.verts[t+1],r.verts[t+2]])}}this.vertDataVBO=new Float32Array(e),console.log(this.vertCount),console.log(this.idxCount)}createCube(){let e=new Array;e.push({pos:[-1,-1,-1],nor:[0,0,-1],uv:[0,0]}),e.push({pos:[1,-1,-1],nor:[0,0,-1],uv:[0,1]}),e.push({pos:[1,1,-1],nor:[0,0,-1],uv:[1,1]}),e.push({pos:[-1,1,-1],nor:[0,0,-1],uv:[1,0]});let t=new Array;t.push({pos:[-1,-1,1],nor:[0,0,1],uv:[0,0]}),t.push({pos:[1,-1,1],nor:[0,0,1],uv:[0,1]}),t.push({pos:[1,1,1],nor:[0,0,1],uv:[1,1]}),t.push({pos:[-1,1,1],nor:[0,0,1],uv:[1,0]});let r=new Array;r.push({pos:[-1,-1,-1],nor:[0,-1,0],uv:[0,0]}),r.push({pos:[1,-1,-1],nor:[0,-1,0],uv:[0,1]}),r.push({pos:[1,-1,1],nor:[0,-1,0],uv:[1,1]}),r.push({pos:[-1,-1,1],nor:[0,-1,0],uv:[1,0]});let s=new Array;s.push({pos:[-1,1,-1],nor:[0,1,0],uv:[0,0]}),s.push({pos:[1,1,-1],nor:[0,1,0],uv:[0,1]}),s.push({pos:[1,1,1],nor:[0,1,0],uv:[1,1]}),s.push({pos:[-1,1,1],nor:[0,1,0],uv:[1,0]});let i=new Array;i.push({pos:[-1,-1,-1],nor:[-1,0,0],uv:[0,0]}),i.push({pos:[-1,1,-1],nor:[-1,0,0],uv:[0,1]}),i.push({pos:[-1,1,1],nor:[-1,0,0],uv:[1,1]}),i.push({pos:[-1,-1,1],nor:[-1,0,0],uv:[1,0]});let o=new Array;o.push({pos:[1,-1,-1],nor:[1,0,0],uv:[0,0]}),o.push({pos:[1,1,-1],nor:[1,0,0],uv:[0,1]}),o.push({pos:[1,1,1],nor:[1,0,0],uv:[1,1]}),o.push({pos:[1,-1,1],nor:[1,0,0],uv:[1,0]}),this.addFace(e),this.addFace(t),this.addFace(r),this.addFace(s),this.addFace(i),this.addFace(o)}}class r{constructor(e){this.vertCount=0,this.verts=new Array;for(let t=0;t<e.length;t++)this.verts.push(e[t]);this.vertCount=e.length}addVertex(e){this.verts.push(e),this.vertCount++}}var s,i=1e-6,o="undefined"!=typeof Float32Array?Float32Array:Array;function n(){var e=new o(3);return o!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function a(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function u(e,t){var r=t[0],s=t[1],i=t[2],o=r*r+s*s+i*i;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function h(){var e=new o(16);return o!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),n(),s=new o(2),o!=Float32Array&&(s[0]=0,s[1]=0);class c{constructor(e,t,r,s,i,h,c,p){var l,d,f;this.eye=n(),this.ref=n(),this.up=n(),this.right=n(),this.look=n(),this.fovy=e,this.aspect=(l=t,d=r,(f=new o(2))[0]=l,f[1]=d,f),this.nearClip=s,this.farClip=i,a(this.eye,h),a(this.ref,c),a(this.up,p),u(this.up,this.up),function(e,t,r){e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2]}(this.look,c,h),u(this.look,this.look),function(e,t,r){var s=t[0],i=t[1],o=t[2],n=r[0],a=r[1],u=r[2];e[0]=i*u-o*a,e[1]=o*n-s*u,e[2]=s*a-i*n}(this.right,this.look,p),u(this.right,this.right)}project(){var e=h();return function(e,t,r,s,i){var o,n=1/Math.tan(t/2);e[0]=n/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(o=1/(s-i),e[10]=(i+s)*o,e[14]=2*i*s*o):(e[10]=-1,e[14]=-2*s)}(e,this.fovy,this.aspect[0]/this.aspect[1],this.nearClip,this.farClip),e}view(){var e=h();return function(e,t,r,s){var o,n,a,u,h,c,p,l,d,f,v=t[0],m=t[1],g=t[2],y=s[0],x=s[1],w=s[2],b=r[0],T=r[1],A=r[2];Math.abs(v-b)<i&&Math.abs(m-T)<i&&Math.abs(g-A)<i?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(p=v-b,l=m-T,d=g-A,o=x*(d*=f=1/Math.hypot(p,l,d))-w*(l*=f),n=w*(p*=f)-y*d,a=y*l-x*p,(f=Math.hypot(o,n,a))?(o*=f=1/f,n*=f,a*=f):(o=0,n=0,a=0),u=l*a-d*n,h=d*o-p*a,c=p*n-l*o,(f=Math.hypot(u,h,c))?(u*=f=1/f,h*=f,c*=f):(u=0,h=0,c=0),e[0]=o,e[1]=u,e[2]=p,e[3]=0,e[4]=n,e[5]=h,e[6]=l,e[7]=0,e[8]=a,e[9]=c,e[10]=d,e[11]=0,e[12]=-(o*v+n*m+a*g),e[13]=-(u*v+h*m+c*g),e[14]=-(p*v+l*m+d*g),e[15]=1)}(e,this.eye,this.ref,this.up),e}model(e){var t=h();return function(e,t,r,s){var o,n,a,u,h,c,p,l,d,f,v,m,g,y,x,w,b,T,A,C,P,U,F,E,M=s[0],B=s[1],S=s[2],V=Math.hypot(M,B,S);V<i||(M*=V=1/V,B*=V,S*=V,o=Math.sin(r),a=1-(n=Math.cos(r)),u=t[0],h=t[1],c=t[2],p=t[3],l=t[4],d=t[5],f=t[6],v=t[7],m=t[8],g=t[9],y=t[10],x=t[11],w=M*M*a+n,b=B*M*a+S*o,T=S*M*a-B*o,A=M*B*a-S*o,C=B*B*a+n,P=S*B*a+M*o,U=M*S*a+B*o,F=B*S*a-M*o,E=S*S*a+n,e[0]=u*w+l*b+m*T,e[1]=h*w+d*b+g*T,e[2]=c*w+f*b+y*T,e[3]=p*w+v*b+x*T,e[4]=u*A+l*C+m*P,e[5]=h*A+d*C+g*P,e[6]=c*A+f*C+y*P,e[7]=p*A+v*C+x*P,e[8]=u*U+l*F+m*E,e[9]=h*U+d*F+g*E,e[10]=c*U+f*F+y*E,e[11]=p*U+v*F+x*E,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]))}(t,t,e,[0,0,1]),t}}var p=function(e,t,r,s){return new(r||(r=Promise))((function(i,o){function n(e){try{u(s.next(e))}catch(e){o(e)}}function a(e){try{u(s.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(n,a)}u((s=s.apply(e,t||[])).next())}))};const l=document.getElementById("gfx-main"),d=new class{constructor(e){this.size=new Array(2),this.time=0,this.timeStep=.01,this.samples=1,this.render=()=>{this.device.queue.writeBuffer(this.uniformBuffer,0,this.camera.model(this.time)),this.device.queue.writeBuffer(this.uniformBuffer,64,this.camera.view()),this.device.queue.writeBuffer(this.uniformBuffer,128,this.camera.project());const e=this.device.createTexture({size:this.size,format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:this.samples}),t=this.device.createCommandEncoder(),r=this.context.getCurrentTexture().createView(),s=this.device.createTexture({size:this.size,sampleCount:this.samples,format:this.format,usage:GPUTextureUsage.RENDER_ATTACHMENT}).createView(),i=t.beginRenderPass({colorAttachments:[{view:4==this.samples?s:this.context.getCurrentTexture().createView(),resolveTarget:4==this.samples?r:void 0,clearValue:{r:.5,g:0,b:.25,a:1},loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:e.createView(),depthClearValue:1,depthLoadOp:"clear",depthStoreOp:"store"}});i.setPipeline(this.pipeline),i.setBindGroup(0,this.bindGroup),i.setVertexBuffer(0,this.mesh.buffer),i.draw(this.mesh.idxCount,1,0,0),i.end(),this.device.queue.submit([t.finish()]),requestAnimationFrame(this.render),this.time+=this.timeStep},this.canvas=e,this.size[0]=e.clientWidth,this.size[1]=e.clientHeight,this.camera=new c(Math.PI/4,e.width,e.height,.1,10,[-5,0,2],[0,0,0],[0,0,1])}initialize(){return p(this,void 0,void 0,(function*(){yield this.setupDevice(),this.createAssets(),yield this.mesh.createTexture(this.device,"https://previews.123rf.com/images/aruba2000/aruba20001611/aruba2000161100262/68716903-old-red-brick-wall-square-texture-cracked-brickwall-frame-background-grungy-stonewall-surface-red-br.jpg"),yield this.makePipeline(),requestAnimationFrame(this.render)}))}waitForTexture(){void 0!==this.mesh.texture?this.mesh.texture?console.log("Texture Loaded"):console.log("Texture Not Loaded"):setTimeout(this.waitForTexture,250)}setupDevice(){return p(this,void 0,void 0,(function*(){if(yield this.secureAdapter(),!this.adapter)return!1;for(;!this.device;)if(yield this.secureAdapter(),!this.adapter)return!1;this.context=this.canvas.getContext("webgpu"),this.format="bgra8unorm",this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}))}secureAdapter(){var e;return p(this,void 0,void 0,(function*(){if(!this.adapter&&(this.adapter=yield null===(e=navigator.gpu)||void 0===e?void 0:e.requestAdapter(),!this.adapter))return null;this.device=yield this.adapter.requestDevice(),this.device.lost.then((e=>{console.error("Device was lost.",e),this.setupDevice()}))}))}makePipeline(){return p(this,void 0,void 0,(function*(){this.uniformBuffer=this.device.createBuffer({size:192,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const e=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}}]}),t=this.device.createSampler({magFilter:"linear",minFilter:"linear"});console.log("TEXTURE NEEDED"),yield this.waitForTexture(),this.bindGroup=this.device.createBindGroup({layout:e,entries:[{binding:0,resource:{buffer:this.uniformBuffer}},{binding:1,resource:t},{binding:2,resource:this.mesh.texture.texture.createView()}]});const r=this.device.createPipelineLayout({bindGroupLayouts:[e]});this.pipeline=this.device.createRenderPipeline({layout:r,vertex:{module:this.device.createShaderModule({code:"struct TransformData {\r\n    model: mat4x4<f32>,\r\n    view: mat4x4<f32>,\r\n    projection: mat4x4<f32>\r\n};\r\n\r\n@binding(0) @group(0) var<uniform> transform: TransformData;\r\n\r\nstruct Fragment {\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) Color : vec4<f32>,\r\n    @location(1) UV: vec2<f32>,\r\n    @location(2) NormalizedPos : vec4<f32>\r\n};\r\n\r\n@vertex\r\nfn vs_main(@location(0) pos: vec3<f32>, @location(1) col: vec3<f32>, @location(2) uv: vec2<f32>) -> Fragment {\r\n    var output : Fragment;\r\n    output.Position = transform.projection * transform.view * transform.model * vec4<f32>(pos, 1.0);\r\n    output.Color = vec4<f32>(col, 1.0);\r\n    output.UV = uv;\r\n    output.NormalizedPos = 0.5 * (vec4(pos, 0.0) + vec4(1.0, 1.0, 1.0, 1.0));\r\n    return output;\r\n}"}),entryPoint:"vs_main",buffers:[this.mesh.bufferLayout]},fragment:{module:this.device.createShaderModule({code:"@group(0) @binding(1) var textureSampler: sampler;\r\n@group(0) @binding(2) var texture: texture_2d<f32>;\r\n\r\n@fragment\r\nfn fs_main(\r\n    @location(0) Color: vec4<f32>,\r\n    @location(1) UV: vec2<f32>,\r\n    @location(2) NormalizedPos : vec4<f32>\r\n) -> @location(0) vec4<f32> {\r\n    return textureSample(texture, textureSampler, UV) * NormalizedPos;\r\n}"}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-list"},depthStencil:{depthWriteEnabled:!0,depthCompare:"less",format:"depth24plus"},multisample:{count:this.samples}})}))}createAssets(){this.mesh=new t(this.device)}}(l);d.initialize()})();